# 狙击对决游戏 (Sniper Duel Game)

一个基于 Bevy 引擎开发的 2D 双人对战狙击游戏，支持**本地双人对战**和**网络联机对战**两种模式。游戏采用创新的分屏设计和部分可见性系统，为玩家带来独特的策略对战体验。

---

## 📋 目录

- [游戏概述](#游戏概述)
- [游戏玩法](#游戏玩法)
- [核心技术](#核心技术)
- [快速开始](#快速开始)
- [项目结构](#项目结构)
- [开发指南](#开发指南)

---

## 🎮 游戏概述

### 核心特色

1. **分屏双视角设计**
   - **左侧**：进攻方第一人称狙击镜视角，沉浸式瞄准体验
   - **右侧**：防守方 2.5D 俯视视角，全局视野和策略规划

2. **部分可见性系统**（核心创新）
   - 进攻方只能通过破碎的墙体看到防守方
   - 墙体由 22 列 × 10 行的砖块组成，每个砖块可独立破坏
   - 实现真实的视线遮挡效果，增加游戏的策略性和紧张感

3. **回合制角色切换**
   - 每回合 30 秒，进攻方有 3 发子弹
   - 回合结束后自动切换进攻方和防守方角色
   - 支持本地双人和网络联机两种模式

4. **平衡性设计**
   - 防守方移动速度为进攻方的 80%
   - 防守方拥有下蹲和侧躲技能，增加生存能力
   - 不同身体部位伤害不同（头部一击必杀）

5. **网络联机支持**
   - 基于 ZeroTier 虚拟局域网实现网络对战
   - 实时同步玩家位置、射击、墙体破坏等状态
   - 支持主机创建房间和客户端加入房间

---

## 🎯 游戏玩法

### 基本规则

1. **角色分配**：游戏开始时随机分配进攻方和防守方角色
2. **回合制**：每回合 30 秒，进攻方有 3 发子弹
3. **胜利条件**：将对方血量降至 0 或回合结束时造成更多伤害
4. **角色切换**：每回合结束后自动切换进攻方和防守方

### 进攻方玩法（左侧视角）

#### 控制方式
- `W/A/S/D`：移动瞄准点（十字准星）
- `空格键`：射击
- 准星位置即为子弹命中点

#### 视角特点
- 第一人称狙击镜视角
- 准星固定在屏幕中心，摄像机跟随瞄准点移动
- **关键机制**：墙被击碎后，只有在破碎处才能看到防守方（部分可见性）
- 不显示激光指示器

#### 策略要点
- 需要先破坏墙体才能看到防守方
- 合理利用 3 发子弹，既要破坏墙体又要命中对手
- 瞄准时考虑防守方的移动轨迹
- 通过墙体破坏创造有利的观察窗口

### 防守方玩法（右侧视角）

#### 控制方式
- `↑/↓/←/→`：移动（移动速度为进攻方的 80%）
- `左 Ctrl`：下蹲（降低被击中概率）
- `左 Shift`：侧躲（左右闪避，有冷却时间）

#### 视角特点
- 2.5D 俯视视角（上帝视角）
- 可以看到进攻方的瞄准线（红色激光）
- 可以看到进攻方的准星位置（红色十字）
- 可以看到墙的破损效果

#### 策略要点
- 观察进攻方的瞄准线，预判射击位置
- 利用墙体遮挡，避免暴露在破碎区域
- 合理使用下蹲和侧躲技能
- 通过移动和技能躲避进攻方的瞄准

### 伤害系统

- **头部**：100 伤害（一击必杀）
- **躯干**：40 伤害
- **腿部**：30 伤害

> **注意**：伤害判定基于射击时准星的位置，而非子弹实际飞行路径，更符合狙击游戏的直觉体验。

### 墙体系统

- 墙体由 **22 列 × 10 行**的砖块组成
- 每个砖块可独立破坏
- 破坏后的砖块在进攻方视角中隐藏，在防守方视角中显示破损效果
- 破损的砖块不阻挡视线检测

### 控制说明

#### 进攻方
- `W/A/S/D`：移动瞄准点
- `空格键`：射击

#### 防守方
- `↑/↓/←/→`：移动（移动速度为进攻方的 80%）
- `左 Ctrl`：下蹲
- `左 Shift`：侧躲

#### 通用
- `R`：重新开始
- `Q`：退出游戏

---

## 🔧 核心技术

### 技术栈

- **引擎**：Bevy 0.13.x（现代 Rust 游戏引擎）
- **架构**：ECS (Entity-Component-System) 架构
- **语言**：Rust（内存安全、高性能）
- **网络**：ZeroTier 虚拟局域网 + UDP 通信

### 核心技术实现

#### 1. ECS 架构设计

采用 Bevy 的 ECS 架构，将游戏逻辑分解为：

- **组件 (Components)**：数据存储（位置、血量、角色等）
- **系统 (Systems)**：逻辑处理（移动、射击、碰撞检测等）
- **资源 (Resources)**：全局状态（回合信息、网络管理器等）

这种架构使得代码结构清晰，易于维护和扩展。

#### 2. 分屏渲染系统

- 使用 `RenderLayers` 实现左右分屏
- **Layer 0**：进攻方视角（左侧）
- **Layer 1**：防守方视角（右侧）
- 每个实体根据 `ViewLayer` 组件分配到相应渲染层

#### 3. 部分可见性系统（核心创新）

这是游戏的核心技术亮点，实现了"只有破碎的墙才能看到对手"的机制。

**实现原理**：
1. 为每个玩家创建两个视角的 sprite 副本（进攻方视角和防守方视角）
2. 将玩家身体分为三个部位（头部、躯干、腿部）
3. 对每个身体部位独立检查可见性
4. 使用射线检测，检查从进攻方到身体部位的射线是否被未破损的墙阻挡
5. 如果被未破损的墙阻挡，该部位隐藏；否则可见

**技术细节**：
- 使用 Bevy 的 `SpatialQuery` 进行射线检测
- 实时更新每个身体部位的可见性
- **性能优化**：只在墙体状态改变时重新计算可见性

#### 4. 网络同步系统

- **状态同步**：玩家位置、血量、动作状态
- **事件同步**：射击、墙体破坏、角色切换
- **延迟处理**：使用缓冲时间机制避免角色切换时的竞态条件
- **相机管理**：网络模式下动态切换相机类型，确保 UI 渲染正常

#### 5. 角色切换缓冲机制

- 引入 `RoleSwitchCooldown` 资源，0.5 秒缓冲时间
- 在缓冲期间，相机系统只停用不符合要求的相机，不删除
- 确保 UI 相机在角色切换时始终存在，避免渲染错误

#### 6. 碰撞检测系统

- 使用射线检测而非传统碰撞体
- 伤害判定基于射击时准星位置，而非子弹飞行路径
- 支持墙体破坏和玩家伤害的精确检测

### 系统执行顺序

游戏系统按照精心设计的顺序执行，确保数据一致性：

1. **输入系统**：处理玩家输入（WASD、方向键、空格等）
2. **动作系统**：处理玩家动作和冷却时间（下蹲、侧躲）
3. **视图系统**：更新视觉元素（准星、激光指示器等）
4. **逻辑系统**：
   - 子弹移动
   - 碰撞检测（墙体破坏、玩家伤害）
   - 墙段可见性更新
   - 防守方可见性检测（核心系统）
   - 回合逻辑（计时器、角色切换）

---

## 🚀 快速开始

### 前置要求

请先查看 [INSTALL.md](INSTALL.md) 了解详细的安装说明。

### 本地双人对战

```bash
cargo run
```

在游戏主菜单中选择"本地双人"即可开始本地对战。

### 网络联机对战

游戏支持通过 ZeroTier 虚拟局域网进行网络联机对战。

**快速开始**：
1. 主机方：运行游戏，选择"局域网对战" -> "创建房间"
2. 客户端：安装 ZeroTier，加入网络，运行游戏，选择"局域网对战" -> "加入房间"

**详细说明**：请查看相关文档
- [ZeroTier安装指南.md](ZeroTier安装指南.md) - ZeroTier 详细安装步骤
- [ZeroTier客户端使用指南.md](ZeroTier客户端使用指南.md) - 客户端详细操作指南

---

## 📁 项目结构

### 文件结构

```
src/
  main.rs          # 主文件，包含游戏初始化、系统注册、常量定义
  gameplay.rs      # 核心游戏逻辑：移动、射击、碰撞检测、可见性系统
  network_game.rs  # 网络游戏逻辑：网络同步、角色切换、相机管理
  menu.rs          # 菜单系统：主菜单、房间创建/加入界面
  network.rs       # 网络通信：UDP 消息处理、ZeroTier 集成
  room.rs          # 房间系统：房间管理、玩家匹配
README.md          # 项目文档
INSTALL.md         # 安装说明
Cargo.toml         # Rust 项目配置
```

### 核心模块说明

#### `main.rs`
- 游戏入口和初始化
- 系统注册和调度
- 常量定义（玩家血量、回合时间、伤害值等）
- 游戏状态管理（菜单、游戏中、游戏结束）

#### `gameplay.rs`
- **输入系统**：进攻方瞄准、射击，防守方移动、动作
- **视图系统**：准星、激光指示器、身体部位位置更新
- **逻辑系统**：子弹移动、碰撞检测、可见性检测
- **相机系统**：相机跟随、视角切换

#### `network_game.rs`
- **网络同步**：玩家位置、射击、墙体破坏同步
- **角色切换**：网络模式下的角色切换逻辑
- **相机管理**：网络模式下的相机切换和 UI 相机管理
- **输入收集**：收集并发送玩家输入到网络

#### `menu.rs`
- 主菜单界面
- 本地双人/网络联机选择
- 房间创建和加入界面

#### `network.rs`
- UDP 通信封装
- ZeroTier 网络检测
- 消息序列化和反序列化

#### `room.rs`
- 房间状态管理
- 玩家匹配逻辑
- 房间代码生成和验证

### 关键常量配置

游戏的关键参数可在 `main.rs` 中调整：

- `PLAYER_HP`：玩家初始血量（100）
- `ROUND_TIME_SECONDS`：回合时长（30秒）
- `BULLETS_PER_ROUND`：每回合子弹数（3发）
- `DAMAGE_HEAD/TORSO/LEGS`：不同部位的伤害值
- `PLAYER_SIZE`：玩家尺寸
- `BRICK_COLS/ROWS`：砖块列数和行数（22列×10行）
- `BRICK_WIDTH/HEIGHT`：单个砖块尺寸
- `PLAYER_MOVE_SPEED`：玩家移动速度（防守方为 80%）
- `CROSSHAIR_DAMAGE_RANGE`：准星破坏范围

---

## 💻 开发指南

### 常见问题

1. **查询冲突**
   - 如果遇到 `error[B0001]`，使用 `ParamSet` 或 `Without<T>` 过滤器
   - 确保不同系统访问的组件不冲突

2. **可见性问题**
   - `Visibility` 是全局的，使用 `RenderLayers` 实现分屏
   - 为不同视角创建不同的 sprite 副本

3. **系统顺序**
   - 使用 `.before()` 和 `.after()` 确保系统执行顺序
   - 数据更新系统应在使用数据的系统之前运行

4. **网络同步**
   - 角色切换时注意缓冲时间，避免相机实体竞态条件
   - 确保 UI 相机在网络模式下始终存在

### 扩展建议

1. **添加音效**：射击、击中、墙破碎等音效
2. **添加粒子效果**：墙破碎、子弹轨迹等
3. **添加更多地图**：不同布局的墙和障碍物
4. **添加武器系统**：不同伤害和射速的武器
5. **改进网络同步**：优化网络延迟和同步机制
6. **添加回放系统**：记录并回放游戏过程

### 项目亮点

1. **创新的部分可见性系统**：实现了"只有破碎的墙才能看到对手"的核心机制
2. **完整的网络联机支持**：基于 ZeroTier 实现稳定的网络对战
3. **优雅的 ECS 架构**：代码结构清晰，易于维护和扩展
4. **平衡的游戏设计**：通过移动速度、技能冷却等机制保证游戏平衡
5. **流畅的角色切换**：通过缓冲机制确保角色切换时的稳定性

---

## 📝 作者说明

这是一个双人对战狙击游戏，重点在于实现**部分可见性系统**，让进攻方只能通过破碎的墙看到防守方，增加了游戏的策略性和紧张感。

代码采用 Bevy ECS 架构，通过组件、系统和资源的方式组织游戏逻辑，便于维护和扩展。项目展示了如何使用 Rust 和 Bevy 引擎开发一个完整的 2D 游戏，包括网络联机、分屏渲染、复杂的可见性检测等高级特性。
